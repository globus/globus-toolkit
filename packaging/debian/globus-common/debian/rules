#!/usr/bin/make -f
# -*- makefile -*-

DEB_HOST_GNU_TYPE  ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
DEB_BUILD_GNU_TYPE ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)

ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
NUMJOBS = $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
MAKEFLAGS += -j$(NUMJOBS)
endif

include /usr/share/quilt/quilt.make

name = globus-common
version = 15.23
soname = 0
toolkit_version = 5.3.1

INSTALLDIR = $(CURDIR)/debian/tmp
DEB_HOST_MULTIARCH ?= $(shell dpkg-architecture -qDEB_HOST_MULTIARCH)

_prefix = /usr
_bindir = $(_prefix)/bin
_sbindir = $(_prefix)/sbin
_includedir = $(_prefix)/include
_libdir = $(_prefix)/lib/$(DEB_HOST_MULTIARCH)
_datadir = $(_prefix)/share
_mandir = $(_datadir)/man
_docdir = $(_datadir)/doc
perl_vendorlib = $(shell eval "`perl -V:installvendorlib`"; echo $$installvendorlib)

DEB_BUILD_ARCH_CPU ?= $(shell dpkg-architecture -qDEB_BUILD_ARCH_CPU)

sed: sed-stamp
	:

sed-stamp: $(QUILT_STAMPFN)
	dh_testdir

	touch $@

unsed: cleanup
	dh_testdir

	rm -f sed-stamp

configure: configure-stamp
	:

configure-stamp: sed-stamp
	dh_testdir

	autoreconf -if

	for f in config.sub config.guess ; do \
	  if [ -e /usr/share/misc/$$f -a ! -e $$f.dist ] ; then \
	    mv build-aux/$$f $$f.dist ; \
	    cp -f /usr/share/misc/$$f build-aux/$$f ; \
	  fi ; \
	done
	GLOBUS_VERSION=$(toolkit_version) ./configure \
 	   --host=$(DEB_HOST_GNU_TYPE) \
	   --prefix=$(_prefix) \
	   --build=$(DEB_BUILD_GNU_TYPE) \
	   --docdir='$(_docdir)/lib$(name)-dev' \
	   --includedir='$(_includedir)/globus' \
	   --datadir='$(_datadir)/globus' \
	   --libdir='$(_libdir)' \
	   --libexecdir='$(_datadir)/globus' \
	   --with-perlmoduledir=$(perl_vendorlib) \
	   --disable-static \
	   --with-backward-compatibility-hack

	touch $@

build: build-stamp
	:

build-stamp: configure-stamp
	dh_testdir

	$(MAKE)
ifeq (,$(filter nocheck,$(DEB_BUILD_OPTIONS)))
	$(MAKE) check
endif

	touch $@

unpatch: unsed

clean: unpatch
	:

cleanup:
	dh_testdir
	dh_testroot

	if [ -r Makefile ] ; then $(MAKE) distclean ; fi

	for f in config.sub config.guess ; do \
	  if [ -e $$f.dist ] ; then \
	    mv -f $$f.dist build-aux/$$f ; \
	  fi ; \
	done

	# Remove autogenerated files

	rm -f aclocal.m4
	rm -f configure
	rm -f depcomp
	rm -f ltmain.sh
	rm -f mkinstalldirs

	rm -f globus_automake*
	rm -rf autom4te.cache

	rm -rf doxygen/doc

	rm -f config.h.in
	rm -f scripts/globus-domainname

	# Remove autogenerated files

	find . -name Makefile.in -exec rm {} ';'

	rm -f build-stamp configure-stamp

	dh_clean debian/*.install

install: build-stamp
	dh_testdir
	dh_testroot
	dh_clean -k

	$(MAKE) install DESTDIR=$(INSTALLDIR)

	# These scripts are intended to be sourced, not executed
	chmod -x $(INSTALLDIR)$(_datadir)/globus/globus-args-parser-header
	chmod -x $(INSTALLDIR)$(_datadir)/globus/globus-script-initializer
	chmod -x $(INSTALLDIR)$(_datadir)/globus/globus-sh-tools.sh

	# Remove .la files
	rm -f $(INSTALLDIR)/$(_libdir)/lib*.la
	# Remove doxygen installdox if present
	rm -f $(INSTALLDIR)/$(_docdir)/lib$(name)-dev/html/installdox
	# Touch ghost files
	touch $(INSTALLDIR)$(_datadir)/globus/globus-sh-tools-vars.sh

	echo debian/tmp$(_datadir)/globus/globus-sh-tools-vars.sh \
	  >> debian/$(name)-progs.install

	ls -1 debian/tmp$(perl_vendorlib)/Globus/Core/*.pm \
	  debian/tmp$(_libdir)/libglobus*.so.* \
	  > debian/lib$(name)$(soname).install
	ls -1 debian/tmp$(_includedir)/globus/*.h \
	  debian/tmp$(_libdir)/*.so \
	  debian/tmp$(_libdir)/pkgconfig/*.pc \
	  > debian/lib$(name)-dev.install
	ls -1 debian/tmp$(_bindir)/* \
	  debian/tmp$(_sbindir)/* \
	  debian/tmp$(_datadir)/globus/* \
	  debian/tmp/$(_mandir)/man1/* \
	  > debian/$(name)-progs.install
	ls -1 debian/tmp$(_docdir)/lib$(name)-dev/html/*.* \
	  debian/tmp$(_docdir)/lib$(name)-dev/html/*/* \
	  debian/tmp/$(_mandir)/man3/* \
	  debian/tmp$(_docdir)/lib$(name)-dev/GLOBUS_LICENSE \
	  > debian/lib$(name)-doc.install

binary-indep:
	:

binary-arch: install
	dh_testdir
	dh_testroot
	mkdir -p debian/lib$(name)-doc$(_docdir)
	ln -s lib$(name)-dev debian/lib$(name)-doc$(_docdir)/lib$(name)-doc
	dh_installchangelogs
	dh_installdocs
	dh_install --fail-missing
	dh_installman
	dh_link
	dh_strip --dbg-package=globus-common-dbg
	dh_compress -X .tag
	dh_fixperms
	dh_perl
	dh_lintian
	dh_makeshlibs
	dh_installdeb
	dh_shlibdeps -l debian/lib$(name)$(soname)/usr/lib
	dh_gencontrol
	dh_md5sums
	# We can't use -X since that matches anywhere in the filename
	sed /globus-sh-tools-vars.sh$$/d -i debian/$(name)-progs/DEBIAN/md5sums
	dh_builddeb

binary: binary-indep binary-arch
	:

.PHONY: build clean binary-indep binary-arch binary install configure

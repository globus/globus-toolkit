dnl

AC_REVISION($Revision$)

AC_INIT(Makefile.am)

GLOBUS_INIT

AM_PROG_LIBTOOL

dnl config header goes here

dnl Initialize the automake rules the last argument
AM_INIT_AUTOMAKE($GPT_NAME, $GPT_VERSION)

dnl Build hooks for all 'builtin' modules
echo -n "Checking for builtin modules... "
GLOBUS_LOCATION=$GLOBUS_LOCATION
MODULE_DIRS=.
MODULE_LIBS=
BUILTIN_EXTENSIONS_DEC=
BUILTIN_EXTENSIONS_DEF=
modules=`ls modules | grep -v CVS | grep -v Makefile`
delim=
if test "X$modules" != "X" ; then
  echo
  for module in $modules ; do
    if test -f modules/$module/Makefile.in ; then
      MODULE_DIRS="$MODULE_DIRS $module"
      lib_name="modules/${module}/libglobus_gridftp_server_${module}.la"
      MODULE_LIBS="$MODULE_LIBS $lib_name"
      
      BUILTIN_EXTENSIONS_DEC="${BUILTIN_EXTENSIONS_DEC}GlobusExtensionDeclareModule(globus_gridftp_server_${module}); "
      BUILTIN_EXTENSIONS_DEF="$BUILTIN_EXTENSIONS_DEF {\"globus_gridftp_server_${module}\", GlobusExtensionMyModule(globus_gridftp_server_${module})},"
      echo "Including module: $module"
    fi
  done
else
  echo "none found"
fi

if test "X$GRIDMAP" != "X" ; then
    GRIDMAP_CONF="-df $GRIDMAP"
else
    if test -f $HOME/.gridmap ; then
        GRIDMAP_CONF="-df $HOME/.gridmap"
    else
        if test -f /etc/grid-security/grid-mapfile ; then
            GRIDMAP_CONF="-df /etc/grid-security/grid-mapfile"
        else
            GRIDMAP_CONF=""
        fi
    fi
fi

AC_SUBST(GRIDMAP_CONF)
AC_SUBST(GLOBUS_LOCATION)
AC_SUBST(MODULE_DIRS)
AC_SUBST(MODULE_LIBS)
AC_SUBST(BUILTIN_EXTENSIONS_DEC)
AC_SUBST(BUILTIN_EXTENSIONS_DEF)

CFLAGS="$CFLAGS -DGLOBUS_BUILTIN"
 
LAC_DOXYGEN("../")

AM_CONFIG_HEADER(config.h)
AC_CHECK_FUNCS(fgetpwent)
AC_C_BIGENDIAN

AC_CANONICAL_BUILD
LDFLHACK=
case "$build" in
  *-*-irix*)
    LDFLHACK="-ignore_unresolved"
    echo "Adding -ignore_unresolved to LDFLAGS for IRIX."
  ;;
esac
AC_SUBST(LDFLHACK)

AC_PATH_PROGS(PERL, perl perl5)

AC_MSG_CHECKING(Toolkit version)
GLOBUS_TOOLKIT_ID=unknown
if test -x ${GLOBUS_LOCATION}/bin/globus-version ; then
    GLOBUS_TOOLKIT_ID="`${GLOBUS_LOCATION:-/usr}/bin/globus-version -full`"
fi
AC_MSG_RESULT($GLOBUS_TOOLKIT_ID)
AC_SUBST(GLOBUS_TOOLKIT_ID)

conf_sbindir="`eval_path $sbindir`"
conf_bindir="`eval_path $bindir`"
conf_libdir="`eval_path $libdir`"
conf_sysconfdir="`eval_path $sysconfdir`"
conf_localstatedir="`eval_path $localstatedir`"
AC_SUBST(conf_sbindir)
AC_SUBST(conf_bindir)
AC_SUBST(conf_libdir) 
AC_SUBST(conf_sysconfdir) 
AC_SUBST(conf_localstatedir)

GLOBUS_FINALIZE

AC_OUTPUT(
    globus-gridftp-password
    globus-gridftp-server-enable-sshftp
    Makefile
    embed/Makefile
    pkgdata/Makefile
    pkgdata/pkg_data_src.gpt
    modules/Makefile
    init/Makefile
    init/globus-gridftp-server
    init/globus-gridftp-sshftp
    gridftp.conf.default
    gridftp.gfork.default
    doxygen/Makefile
    doxygen/Doxyfile
    doxygen/Doxyfile-internal
    version.h
    extensions.h
dnl NOTE: do not put anything below this line!
